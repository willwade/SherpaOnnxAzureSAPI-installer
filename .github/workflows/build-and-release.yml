name: Build and Release

on:
  push:
    branches: [ main ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]

jobs:
  build-native:
    name: Build Native DLL
    runs-on: windows-2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download SherpaOnnx library
      run: pwsh -File scripts/Download-SherpaOnnx.ps1

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      with:
        msbuild-architecture: x64

    - name: Build NativeTTSWrapper
      run: |
        msbuild NativeTTSWrapper\NativeTTSWrapper.sln /t:Build /p:Configuration=Release /p:Platform=x64 /v:minimal

    - name: Verify DLL was built
      run: |
        Write-Host "Verifying NativeTTSWrapper.dll..." -ForegroundColor Yellow
        $dllPath = "NativeTTSWrapper\x64\Release\NativeTTSWrapper.dll"
        if (Test-Path $dllPath) {
          $dllSize = (Get-Item $dllPath).Length / 1MB
          Write-Host "✓ NativeTTSWrapper.dll built: $([math]::Round($dllSize, 2)) MB" -ForegroundColor Green
          Write-Host "  Path: $((Get-Item $dllPath).FullName)" -ForegroundColor Cyan
        } else {
          Write-Host "✗ NativeTTSWrapper.dll NOT FOUND!" -ForegroundColor Red
          Write-Host "Files in build output:" -ForegroundColor Yellow
          Get-ChildItem -Path "NativeTTSWrapper\x64\Release\" -ErrorAction SilentlyContinue | Format-Table Name, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB,2)}}
          exit 1
        }

    - name: Upload DLL artifact
      uses: actions/upload-artifact@v4
      with:
        name: NativeTTSWrapper-x64
        path: NativeTTSWrapper/x64/Release/NativeTTSWrapper.dll
        retention-days: 30

    - name: Upload dependency DLLs
      uses: actions/upload-artifact@v4
      with:
        name: Dependencies
        path: |
          NativeTTSWrapper/x64/Release/*.dll
          !NativeTTSWrapper/x64/Release/NativeTTSWrapper.dll
        retention-days: 30

  build-installer:
    name: Build Console Installer
    runs-on: windows-2022
    needs: build-native

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Download Native DLL artifact
      uses: actions/download-artifact@v4
      with:
        name: NativeTTSWrapper-x64
        path: NativeTTSWrapper/x64/Release/

    - name: Build Console Installer
      run: dotnet build Installer/Installer.csproj -c Release --no-dependencies

    - name: Upload installer artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: SherpaOnnxSAPIInstaller
        path: Installer/bin/Release/net8.0/SherpaOnnxSAPIInstaller.exe
        retention-days: 30

  build-config-app:
    name: Build Configuration App
    runs-on: windows-2022

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Build Config App
      run: dotnet build ConfigApp/ConfigApp.csproj -c Release

    - name: Upload Config App artifact
      uses: actions/upload-artifact@v4
      with:
        name: SherpaOnnxConfig
        path: ConfigApp/bin/Release/net8.0-windows/
        retention-days: 30

  build-msi:
    name: Build MSI Installer
    runs-on: windows-2022
    needs: build-native

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Native DLL artifact
      uses: actions/download-artifact@v4
      with:
        name: NativeTTSWrapper-x64
        path: NativeTTSWrapper/x64/Release/

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      with:
        msbuild-architecture: x64

    - name: Build ConfigApp for release
      run: |
        Write-Host "Building ConfigApp for release..." -ForegroundColor Yellow
        dotnet build ConfigApp/ConfigApp.csproj -c Release

    - name: Build Console Installer for release
      run: |
        Write-Host "Building Console Installer for release..." -ForegroundColor Yellow
        dotnet build Installer/Installer.csproj -c Release

    - name: Download WiX Toolset
      run: |
        Write-Host "Downloading WiX Toolset v3.14..." -ForegroundColor Yellow
        $url = "https://github.com/wixtoolset/wix3/releases/download/wix3141rtm/wix314-binaries.zip"
        Invoke-WebRequest -Uri $url -OutFile wix314-binaries.zip -UseBasicParsing
        Expand-Archive -Path wix314-binaries.zip -DestinationPath wix-tools -Force
        Write-Host "✅ WiX Toolset extracted" -ForegroundColor Green

    - name: Verify DLL exists before building MSI
      run: |
        Write-Host "Checking for NativeTTSWrapper.dll..." -ForegroundColor Yellow
        $dllPath = "NativeTTSWrapper\x64\Release\NativeTTSWrapper.dll"
        if (Test-Path $dllPath) {
          $dllSize = (Get-Item $dllPath).Length / 1MB
          Write-Host "✓ Found NativeTTSWrapper.dll ($([math]::Round($dllSize, 2)) MB)" -ForegroundColor Green
          Write-Host "  Full path: $((Get-Item $dllPath).FullName)" -ForegroundColor Cyan
        } else {
          Write-Host "✗ NativeTTSWrapper.dll NOT FOUND!" -ForegroundColor Red
          Write-Host "  Working directory: $((Get-Location).Path)" -ForegroundColor Yellow
          Write-Host "  Looking for: $dllPath" -ForegroundColor Yellow
          Write-Host "  Files in directory:" -ForegroundColor Yellow
          Get-ChildItem -Path "NativeTTSWrapper\x64\Release\" -ErrorAction SilentlyContinue | Select-Object Name, @{Name="Size(MB)";Expression={[math]::Round($_.Length/1MB,2)}} | Format-Table -AutoSize
          exit 1
        }
        Write-Host ""
        Write-Host "Checking paths from Installer directory perspective..." -ForegroundColor Yellow
        Push-Location Installer
        $relativePath = "..\NativeTTSWrapper\x64\Release\NativeTTSWrapper.dll"
        if (Test-Path $relativePath) {
          Write-Host "✓ Found via relative path: $relativePath" -ForegroundColor Green
        } else {
          Write-Host "✗ NOT found via relative path: $relativePath" -ForegroundColor Red
        }
        Pop-Location

    - name: Build MSI with WiX
      run: |
        Write-Host "Building MSI installer..." -ForegroundColor Yellow
        Write-Host "  Working directory: $((Get-Location).Path)" -ForegroundColor Cyan

        # List files WiX will try to include
        Write-Host "`nFiles WiX will try to include:" -ForegroundColor Cyan
        Write-Host "  From Installer/Product.wxs perspective:" -ForegroundColor Gray
        Push-Location Installer
        Write-Host "    ..\NativeTTSWrapper\x64\Release\NativeTTSWrapper.dll" -ForegroundColor Gray
        if (Test-Path "..\NativeTTSWrapper\x64\Release\NativeTTSWrapper.dll") {
          Write-Host "      EXISTS" -ForegroundColor Green
        } else {
          Write-Host "      NOT FOUND!" -ForegroundColor Red
        }
        Write-Host "    ..\NativeTTSWrapper\engines_config.json" -ForegroundColor Gray
        if (Test-Path "..\NativeTTSWrapper\engines_config.json") {
          Write-Host "      EXISTS" -ForegroundColor Green
        } else {
          Write-Host "      NOT FOUND!" -ForegroundColor Red
        }
        Write-Host "    ..\ConfigApp\bin\Release\net8.0-windows\SherpaOnnxConfig.exe" -ForegroundColor Gray
        if (Test-Path "..\ConfigApp\bin\Release\net8.0-windows\SherpaOnnxConfig.exe") {
          Write-Host "      EXISTS" -ForegroundColor Green
        } else {
          Write-Host "      NOT FOUND!" -ForegroundColor Red
        }
        Pop-Location

        # Compile WiX source with verbose output
        Write-Host "`nCompiling WiX source..." -ForegroundColor Yellow
        .\wix-tools\candle.exe Installer\Product.wxs -out Installer\Product.wixobj -ext WixUIExtension.dll -ext WixUtilExtension.dll -v

        # Link to create MSI with verbose output
        Write-Host "`nLinking MSI..." -ForegroundColor Yellow
        .\wix-tools\light.exe Installer\Product.wixobj -out SherpaOnnxSAPI.msi -ext WixUIExtension.dll -ext WixUtilExtension.dll -sval -v

        Write-Host "`n✅ MSI built successfully" -ForegroundColor Green

        # Show file size
        $msiSize = (Get-Item SherpaOnnxSAPI.msi).Length / 1MB
        Write-Host "MSI Size: $([math]::Round($msiSize, 2)) MB" -ForegroundColor Cyan

        # List MSI contents using Windows COM
        Write-Host "`nMSI Contents:" -ForegroundColor Cyan
        try {
          $msi = New-Object -ComObject WindowsInstaller.Installer
          $db = $msi.OpenDatabase("SherpaOnnxSAPI.msi", 0)
          $view = $db.OpenView("SELECT FileName FROM File")
          $view.Execute()
          $file = $view.Fetch()
          $files = @()
          while ($file -ne $null) {
            $files += $file.StringData(1)
            $file = $view.Fetch()
          }
          Write-Host "  Files in MSI: $($files.Count)" -ForegroundColor Yellow
          foreach ($f in $files) {
            Write-Host "    - $f" -ForegroundColor Gray
          }
          $view.Close()
          $db.Close()
          [System.Runtime.Interopservices.Marshal]::ReleaseComObject($msi) | Out-Null
        } catch {
          Write-Host "  Cannot list contents (WindowsInstaller COM error)" -ForegroundColor Yellow
        }

    - name: Upload MSI artifact
      uses: actions/upload-artifact@v4
      with:
        name: SherpaOnnxSAPI-MSI
        path: SherpaOnnxSAPI.msi
        retention-days: 90

  test:
    name: Test SAPI5 Integration
    runs-on: windows-2022
    needs: build-native

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download Native DLL artifact
      uses: actions/download-artifact@v4
      with:
        name: NativeTTSWrapper-x64
        path: NativeTTSWrapper/x64/Release/

    - name: Copy config file
      run: Copy-Item NativeTTSWrapper\engines_config.json NativeTTSWrapper\x64\Release\

    - name: Register DLL
      shell: pwsh
      run: regsvr32 "${{ github.workspace }}\NativeTTSWrapper\x64\Release\NativeTTSWrapper.dll"

    - name: Copy config file
      run: Copy-Item NativeTTSWrapper\engines_config.json NativeTTSWrapper\x64\Release\

    - name: Create SAPI5 voice registry keys for testing
      shell: pwsh
      run: |
        # Create SAPI5 voice token registry keys (normally done by MSI installer)
        New-Item -Path "HKLM:\SOFTWARE\Microsoft\Speech\Voices\Tokens\TestSherpaVoice" -Force | Out-Null
        New-Item -Path "HKLM:\SOFTWARE\Microsoft\Speech\Voices\Tokens\TestSherpaVoice\Attributes" -Force | Out-Null
        New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Speech\Voices\Tokens\TestSherpaVoice" -Name "(default)" -Value "Test Sherpa Voice" -Force | Out-Null
        New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Speech\Voices\Tokens\TestSherpaVoice" -Name "CLSID" -Value "{A1B2C3D4-E5F6-4A5B-8C9D-1E2F3A4B5C6D}" -Force | Out-Null
        New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Speech\Voices\Tokens\TestSherpaVoice" -Name "Language" -Value "409" -Force | Out-Null
        New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Speech\Voices\Tokens\TestSherpaVoice" -Name "Gender" -Value "Female" -Force | Out-Null
        New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Speech\Voices\Tokens\TestSherpaVoice" -Name "Age" -Value "Adult" -Force | Out-Null
        New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Speech\Voices\Tokens\TestSherpaVoice" -Name "Vendor" -Value "OpenAssistive" -Force | Out-Null
        New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Speech\Voices\Tokens\TestSherpaVoice" -Name "Name" -Value "TestSherpaVoice" -Force | Out-Null
        New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Speech\Voices\Tokens\TestSherpaVoice\Attributes" -Name "Language" -Value "409" -Force | Out-Null
        New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Speech\Voices\Tokens\TestSherpaVoice\Attributes" -Name "Gender" -Value "Female" -Force | Out-Null
        New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Speech\Voices\Tokens\TestSherpaVoice\Attributes" -Name "Age" -Value "Adult" -Force | Out-Null
        New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Speech\Voices\Tokens\TestSherpaVoice\Attributes" -Name "Vendor" -Value "OpenAssistive" -Force | Out-Null
        New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Speech\Voices\Tokens\TestSherpaVoice\Attributes" -Name "Name" -Value "TestSherpaVoice" -Force | Out-Null

    - name: Run test suite
      shell: pwsh
      run: |
        Add-Type -AssemblyName System.Speech
        $synth = New-Object System.Speech.Synthesis.SpeechSynthesizer

        # Test 1: Verify voice is installed
        Write-Host "Testing: Voice registration..."
        $installedVoice = $synth.GetInstalledVoices() | Where-Object { $_.VoiceInfo.Name -eq "TestSherpaVoice" }
        if ($installedVoice) {
            Write-Host "  [OK] TestSherpaVoice is registered"
        } else {
            Write-Host "  [FAIL] TestSherpaVoice not found"
            exit 1
        }

        # Test 2: Verify voice can be selected
        Write-Host "Testing: Voice selection..."
        try {
            $synth.SelectVoice("TestSherpaVoice")
            Write-Host "  [OK] TestSherpaVoice can be selected"
        } catch {
            Write-Host "  [FAIL] Cannot select TestSherpaVoice: $_"
            exit 1
        }

        # Test 3: Verify voice attributes
        Write-Host "Testing: Voice attributes..."
        $voiceInfo = $synth.Voice
        if ($voiceInfo.Name -eq "TestSherpaVoice") {
            Write-Host "  [OK] Voice: $($voiceInfo.Name)"
            Write-Host "  [OK] Gender: $($voiceInfo.Gender)"
            Write-Host "  [OK] Age: $($voiceInfo.Age)"
            Write-Host "  [OK] Culture: $($voiceInfo.Culture.Name)"
        } else {
            Write-Host "  [FAIL] Unexpected voice: $($voiceInfo.Name)"
            exit 1
        }

        # Note: Skipping actual Speak() test as CI runners have no audio device
        Write-Host ""
        Write-Host "All SAPI5 tests passed!" -ForegroundColor Green

    - name: Cleanup SAPI5 registry keys
      if: always()
      shell: pwsh
      run: |
        Remove-Item -Path "HKLM:\SOFTWARE\Microsoft\Speech\Voices\Tokens\TestSherpaVoice" -Recurse -Force -ErrorAction SilentlyContinue

    - name: Unregister DLL
      if: always()
      shell: pwsh
      run: regsvr32 /u "${{ github.workspace }}\NativeTTSWrapper\x64\Release\NativeTTSWrapper.dll"

  release:
    name: Create Release
    runs-on: windows-2022
    needs: [build-native, build-installer, build-config-app, build-msi, test]
    if: startsWith(github.ref, 'refs/tags/v')

    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts/

    - name: Create release package
      shell: pwsh
      run: |
        $version = "${{ github.ref_name }}"
        $version = $version -replace 'refs/tags/v', ''

        # Create package directory
        New-Item -ItemType Directory -Force -Path "package\SherpaOnnxSAPI"

        # Copy DLL
        Copy-Item "artifacts\NativeTTSWrapper-x64\*" "package\SherpaOnnxSAPI\" -Recurse

        # Copy config
        Copy-Item "NativeTTSWrapper\engines_config.json" "package\SherpaOnnxSAPI\"

        # Copy documentation
        Copy-Item "*.md" "package\SherpaOnnxSAPI\" -Exclude "MILESTONE_SUMMARY.md"

        # Copy test script
        Copy-Item "test_sapi5_extended.ps1" "package\SherpaOnnxSAPI\"

        # Create install script
        @"
        # SherpaOnnx SAPI5 TTS Engine - Install Script
        Write-Host "Installing SherpaOnnx SAPI5 TTS Engine..."

        # Register DLL
        regsvr32 "$PSScriptRoot\NativeTTSWrapper.dll"
        if ($LASTEXITCODE -ne 0) {
            Write-Host "ERROR: Failed to register DLL"
            exit 1
        }

        Write-Host "Installation complete!"
        Write-Host ""
        Write-Host "To test:"
        Write-Host "  Add-Type -AssemblyName System.Speech"
        Write-Host "  `$voice = New-Object System.Speech.Synthesis.SpeechSynthesizer"
        Write-Host "  `$voice.SelectVoice('TestSherpaVoice')"
        Write-Host "  `$voice.Speak('Hello world')"
        "@ | Out-File "package\SherpaOnnxSAPI\install.ps1" -Encoding UTF8

        # Create uninstall script
        @"
        # SherpaOnnx SAPI5 TTS Engine - Uninstall Script
        Write-Host "Uninstalling SherpaOnnx SAPI5 TTS Engine..."
        regsvr32 /u "$PSScriptRoot\NativeTTSWrapper.dll"
        Write-Host "Uninstallation complete!"
        "@ | Out-File "package\SherpaOnnxSAPI\uninstall.ps1" -Encoding UTF8

    - name: Create ZIP package
      run: Compress-Archive -Path package/* -DestinationPath "SherpaOnnxSAPI-${{ github.ref_name }}.zip"

    - name: Generate Release Notes
      id: release_notes
      uses: actions/github-script@v7
      with:
        script: |
          const version = '${{ github.ref_name }}'.replace('refs/tags/v', '');
          const notes = `## SherpaOnnx SAPI5 TTS Engine v${version}

          ### Installation

          **Option 1: MSI Installer (Recommended)**
          1. Download \`SherpaOnnxSAPI.msi\`
          2. Run the installer - it will register the SAPI5 voice and install the configuration app
          3. Use the "SherpaOnnx Voice Config" desktop shortcut to download and configure voices

          **Option 2: Manual ZIP Installation**
          1. Download \`SherpaOnnxSAPI-${{ github.ref_name }}.zip\`
          2. Extract to a folder (e.g., \`C:\\Program Files\\OpenAssistive\\OpenSpeech\`)
          3. Run \`install.ps1\` as Administrator
          4. Test with PowerShell:
              \`\`\`
              Add-Type -AssemblyName System.Speech
              $voice = New-Object System.Speech.Synthesis.SpeechSynthesizer
              $voice.SelectVoice('TestSherpaVoice')
              $voice.Speak('Hello world')
              \`\`\`

          ### Changes
          - Native SAPI5 COM implementation with SherpaOnnx v1.12.10
          - vits-piper-en_US-amy-low voice model (16kHz)
          - Sample rate matching fix (no more "Minnie Mouse" effect)
          - Voice speed: lengthScale=1.15 (15% slower for natural speech)

          ### Documentation
          - [BUILD.md](BUILD.md) - Build instructions
          - [SETUP.md](SETUP.md) - Configuration guide
          - [ARCHITECTURE.md](ARCHITECTURE.md) - System design
          - [TROUBLESHOOTING.md](TROUBLESHOOTING.md) - Common issues

          ### Requirements
          - Windows 10/11 (x64)
          - No .NET runtime needed for SAPI5 engine
          - 250MB RAM minimum

          Full source: https://github.com/OpenAssistive/SherpaOnnxSAPI-installer
          `;
          core.setOutput('notes', notes);

    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          SherpaOnnxSAPI-${{ github.ref_name }}.zip
          artifacts/SherpaOnnxSAPI-MSI/SherpaOnnxSAPI.msi
        body: ${{ steps.release_notes.outputs.notes }}
        draft: false
        prerelease: false
        generate_release_notes: false
# Build timestamp: 2026-02-09T23:59:51Z
